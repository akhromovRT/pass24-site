# AI-проверка Pull Request

Автоматическая проверка PR с помощью Codex и Copilot.

## Параметры

$ARGUMENTS — номер PR (обязательный). Пример: `/pullrequest 19`

## Инструкции

### 1. Валидация параметров

Если `$ARGUMENTS` пустой или не является числом:
- Запросить номер PR у пользователя через AskUserQuestion
- Альтернативно: получить список открытых PR командой `gh pr list` и предложить выбор

### 2. Запуск проверки Codex

```bash
gh pr comment $ARGUMENTS --body "@codex проверь"
```

Сообщить пользователю, что проверка запущена.

### 3. Ожидание анализа (5 минут)

```bash
sleep 300
```

Информировать пользователя о времени ожидания.

### 4. Получение комментариев от AI-агентов

```bash
gh api repos/:owner/:repo/pulls/$ARGUMENTS/comments \
  --jq '.[] | select(.user.login | test("copilot|codex"; "i")) | "[\(.user.login)] \(.body)"'
```

Примечание: `:owner/:repo` автоматически подставляется gh из текущего репозитория.

### 5. Анализ замечаний

Для каждого замечания от AI-агентов:

1. **Определить приоритет:**
   - P1 (Critical) — исправить перед мержем
   - P2 (Important) — рекомендуется исправить
   - Suggestions — на усмотрение

2. **Оценить обоснованность:**
   - AI-агенты могут давать ложноположительные замечания
   - Проверить, указывает ли замечание на реальную проблему

3. **Предложить действия:**
   - Если замечание обосновано — предложить исправление кода
   - Если ложноположительное — объяснить почему можно игнорировать

### 6. Применение исправлений (если требуется)

После согласования с пользователем:

1. Внести исправления в код
2. Закоммитить и запушить:
   ```bash
   git add . && git commit -m "fix: address AI review comments" && git push
   ```
3. Повторно запустить проверку (вернуться к шагу 2)

### 7. Ожидание деплоя (после одобрения)

Когда критичных замечаний не осталось:

```bash
sleep 300
```

Дождаться завершения GitHub Action деплоя.

### 8. Завершение

Сообщить пользователю:
- Статус проверки (все замечания обработаны / остались suggestions)
- Готовность PR к мержу
- Статус деплоя (если применимо)

## Поведение

- Всегда показывать замечания пользователю перед исправлением
- Спрашивать подтверждение перед каждым циклом повторной проверки
- При отсутствии замечаний от AI — сразу переходить к ожиданию деплоя
- Использовать TodoWrite для отслеживания прогресса при множественных замечаниях
