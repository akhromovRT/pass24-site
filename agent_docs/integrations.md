# Интеграции и автоматизация продаж

> Синхронизировано с `agent_docs/technical-spec.md` (февраль 2026)

## Архитектура передачи лидов

```
┌──────────────────────────────────────────────────────┐
│  WORDPRESS                                             │
│                                                        │
│  Gravity Forms + Flamix Bitrix24                       │
│  JivoSite чат                                         │
│  Калькулятор ROI (JS → webhook)                        │
│  Конфигуратор решений (JS → webhook)                   │
│                                                        │
│  mu-plugin pass24-ai-factory.php (fire-and-forget):    │
│    POST → crm.lead.add (Битрикс24)                     │
│    POST → AI_FACTORY_URL/api/webhooks/lead             │
└──────────────┬──────────────────────┬─────────────────┘
               ▼                      ▼
┌──────────────────────┐  ┌───────────────────────────────┐
│  БИТРИКС24 CRM        │  │  PASS24 AI SALES FACTORY       │
│                       │  │  (pass24-ai-sales, Phase 3)    │
│  Лид → Скоринг        │  │                               │
│  (UF_CRM_LEAD_SCORE)  │  │  Lead Generator → Lead Scorer  │
│                       │  │  → EventBus → Nurturing Agent  │
│  Скор > 70  → Сделка  │  │                               │
│  Скор 30–70 → Nurture │  │  Content: ContentWriter →      │
│  Скор < 30  → Marketing│  │  SEO Optimizer →              │
│                       │  │  POST /wp/v2/posts (draft)     │
│  Воронка: Новый →     │  │  → Telegram HITL → publish     │
│  Квалифицирован →     │  │                               │
│  Демо → КП →          │  │  Синхронизация с Битрикс24:    │
│  Переговоры →         │  │  двусторонняя (Phase 3.4)      │
│  Победа/Поражение     │  │                               │
└───────────────────────┘  └───────────────────────────────┘
```

## Модель скоринга лидов

Поле в Битрикс24: `UF_CRM_LEAD_SCORE` (Integer)
Обновляется через n8n на основе событий GA4 + Яндекс.Метрики.

| Поведение | Баллы |
|---|---|
| Отправка запроса демо / заявка на пилот | +30 |
| Использование калькулятора ROI | +20 |
| Скачивание спецификации/PDF | +20 |
| Посещение страницы тарифов | +15 |
| Тип компании = Застройщик/УК (ICP) | +15 |
| Просмотр 3+ страниц продуктов | +10 |
| Возврат на сайт в течение 7 дней | +10 |
| Просмотр видео >50% | +10 |
| Email-домен = gmail/mail.ru | −5 |

## Гео-маршрутизация (перспектива MENA)

Поле `UF_CRM_REGION` автозаполняется по гео-IP через плагин If-So:
- RU → основная воронка
- AE/SA/EG → MENA-воронка (отдельный менеджер)

## WordPress REST API для автопубликации (n8n)

**Аутентификация:** Application Passwords
- WordPress Пользователи → Редактировать профиль → Пароли приложений
- Заголовок: `Authorization: Basic base64(username:app_password)`

**Создание черновика статьи:**
```http
POST /wp/v2/posts
{
  "title": "Заголовок статьи",
  "content": "<html-контент>",
  "status": "draft",
  "categories": [id_категории],
  "featured_media": id_медиа,
  "meta": {
    "rank_math_title": "SEO-заголовок | PASS24",
    "rank_math_description": "SEO мета-описание (100–165 символов)",
    "rank_math_focus_keyword": "целевой ключ"
  }
  // Поля зарегистрированы в mu-plugins/pass24-ai-factory.php через register_post_meta()
  // AI Sales Factory отправляет rank_math_title + rank_math_description автоматически
}
```

**Загрузка изображения:**
```http
POST /wp/v2/media
Content-Type: image/jpeg
Content-Disposition: attachment; filename="image.jpg"
[binary content]
```

## Публикация контента (AI Sales Factory → WordPress)

> **ADR-012:** n8n для публикации контента заменён на pass24-ai-sales.
> Pipeline: ContentWriter → SEO Optimizer → `POST /wp/v2/posts` (status: draft)
> → Telegram HITL (approve) → `PATCH /wp/v2/posts/{id}` (status: publish).
> Поля Rank Math заполняются автоматически из SEO-данных.

## n8n Workflow — (устарело, см. ADR-012)

```
Триггер: Еженедельный cron (понедельник 09:00)
  ↓
Шаг 1: HTTP Request → Claude API
  Промпт: «Напиши SEO-статью на тему {тема} для аудитории УК/застройщиков.
           Язык: русский. Длина: 1500–2000 слов. Формат: HTML.
           Используй ключ: {ключевое_слово}»
  ↓
Шаг 2: HTTP Request → Pexels API
  Параметры: query="{тема}" + size=landscape
  ↓
Шаг 3: POST /wp/v2/media (загрузка featured image)
  ↓
Шаг 4: POST /wp/v2/posts (статус: draft)
  ↓
Шаг 5: Битрикс24 — уведомление контент-менеджеру на ревью
```

## Квалификационный чат-бот (JivoSite)

Контекстные приветствия по URL:

| URL | Первое сообщение |
|---|---|
| `/products/*` | «Какой тип объекта вы управляете?» |
| `/pricing/` | «Сколько точек доступа вам нужно?» |
| `/solutions/residential-complex/` | «Сколько ЖК управляет ваша УК?» |
| `/solutions/cottage-village/` | «Сколько КПП на вашем объекте?» |
| `/solutions/logistics/` | «Сколько транспортных единиц обслуживает ваш комплекс?» |
| `/solutions/production/` | «Сколько сотрудников и подрядчиков на объекте?» |
| `/demo/` | «Хотите записаться прямо сейчас? Выберите удобное время» |

Ветки после ответа:
- ЖК → сегментная воронка для застройщиков
- КП → воронка для коттеджных посёлков
- БЦ → коммерческая воронка
- Логистика / Производство → промышленная воронка

Все данные чата передаются в Битрикс24 как лид.

## Структура UTM-меток

```
Яндекс.Директ:  ?utm_source=yandex&utm_medium=cpc&utm_campaign=skud_zhk_msk
VK Реклама:     ?utm_source=vk&utm_medium=social&utm_campaign=bc_access_control
Email:          ?utm_source=email&utm_medium=newsletter&utm_campaign=q1_2026
Telegram:       ?utm_source=telegram&utm_medium=social&utm_campaign=blog_post
```

Плагин Flamix автоматически захватывает UTM и передаёт в поля лида CRM.

## Nurture email-цепочка (Битрикс24 / Unisender)

| День | Тема письма | Действие при клике |
|---|---|---|
| 0 | Добро пожаловать + «Что такое облачная СКУД» | — |
| 3 | «5 признаков, что ваш объект нужно обновить» | — |
| 7 | Кейс по сегменту лида (авто-выбор из CRM) | — |
| 10 | Сравнительный гайд + CTA на демо | Мгновенное уведомление менеджеру |
| 14 | ROI-калькулятор + видео-отзыв | +20 баллов скоринга |
| 21 | Спецпредложение / акция | — |
| 30 | Реактивация или архивация | — |

## Многошаговая форма захвата лидов

Центральный оффер: **пилот 14 дней** (обучение + онлайн-сопровождение включены).

```
Шаг 1 (3 поля, низкий барьер):
  - Имя
  - Телефон
  - Email

Шаг 2 (3 поля, квалификация):
  - Тип объекта: ЖК / КП / БЦ / Склад / Производство / Другое
  - Количество точек доступа: 1-5 / 5-20 / 20-50 / 50+
  - Есть ли текущий СКУД? да / нет

Шаг 3 (2 поля, высокий интент):
  - Предпочтительное время для звонка
  - Комментарий (необязательно)
```

Каждый шаг автосохраняется в Битрикс24 через Flamix webhook — даже неполные отправки Шага 1 создают лид.
